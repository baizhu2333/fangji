// 新增：中文数字转阿拉伯数字工具函数（覆盖十、十五、三十等）
function cnNumToArabic(cnNum) {
    const cnNumMap = {
        '零': 0, '一': 1, '二': 2, '三': 3, '四': 4,
        '五': 5, '六': 6, '七': 7, '八': 8, '九': 9,
        '十': 10, '百': 100, '千': 1000
    };
    
    // 先处理简单映射（如“十”直接返回10）
    if (cnNumMap[cnNum]) return cnNumMap[cnNum];
    
    let result = 0;
    let temp = 0;
    // 遍历中文数字字符，处理组合（如“十五=15”“三十=30”）
    for (let i = 0; i < cnNum.length; i++) {
        const char = cnNum[i];
        const num = cnNumMap[char] || 0;
        
        if (num === 10) { // 处理“十”
            temp = temp === 0 ? 10 : temp * 10;
        } else if (num >= 100) { // 处理“百、千”（方剂中较少用到，预留兼容）
            result += (temp === 0 ? 1 : temp) * num;
            temp = 0;
        } else { // 处理个位数（一~九）
            if (temp === 10) { // 如“十五”=10+5
                result += temp + num;
                temp = 0;
            } else {
                temp = temp * 10 + num;
            }
        }
    }
    result += temp;
    // 兼容方剂中常见的“十五、三十”等，确保返回有效数字
    return result > 0 ? result : 0;
}

function parsePrescription(text) {
    const herbs = [];
    
    // 第一步：清理文本中的无关词汇和符号
    text = text.replace(/大片/g, '3');
    text = text.replace(/个|枚/g, '');
    text = text.replace(/后下化开/g, '后下');
    text = text.replace(/化开/g, '烊化');
    text = text.replace(/（/g, '(').replace(/）/g, ')');
    text = text.replace(/克|g|G/g, ''); // 移除重量单位，方便后续提取用量
    
    // 第二步：拆分文本为单行（支持换行、逗号、顿号分隔）
    const lines = text.split(/[\n,，、]/);
    
    for (let line of lines) {
        line = line.trim();
        if (!line) continue;
        
        // 提取煎药方法（如“(后下)”）
        let method = '';
        const methodMatch = line.match(/\((.*?)\)/);
        if (methodMatch) {
            method = methodMatch[1];
            line = line.replace(methodMatch[0], '').trim();
        }
        
        // 第三步：优化正则，精准匹配“药材 用量”（支持中文数字、阿拉伯数字）
        // 正则说明：
        // [\u4e00-\u9fa5]{2,4} 匹配2-4个中文字符的药材名称
        // \s* 匹配任意空白字符
        // (?:\d+(?:\.\d+)?|[\u4e00-\u9fa5]{1,2}) 匹配阿拉伯数字（含小数）或1-2个中文数字（十、十五等）
        const pattern = /([\u4e00-\u9fa5]{2,4})\s*(\d+(?:\.\d+)?|[\u4e00-\u9fa5]{1,2})/g;
        let match;
        
        while ((match = pattern.exec(line)) !== null) {
            let name = match[1].trim();
            let weightStr = match[2].trim();
            let weight = 0;
            
            // 第四步：处理药材名称（移除多余前缀，仅保留有效名称）
            if (name.length === 3 && name.startsWith('生')) {
                name = name.substring(1);
            }
            
            // 第五步：处理用量（中文数字转阿拉伯数字，或直接解析阿拉伯数字）
            if (/^\d+$/.test(weightStr)) {
                // 阿拉伯数字直接转换
                weight = parseFloat(weightStr);
            } else {
                // 中文数字转阿拉伯数字
                weight = cnNumToArabic(weightStr);
            }
            
            // 第六步：仅对“大枣、生姜”补充默认值（修复原代码误作用于其他药材的问题）
            if ((name === '大枣' || name === '生姜') && (weight === 0 || weight === 1)) {
                weight = 5;
            }
            
            // 第七步：验证有效用量，添加到药材列表
            if (!isNaN(weight) && weight > 0) {
                herbs.push({
                    name: name,
                    weight: weight,
                    method: method
                });
            }
        }
    }
    
    // 去重并合并同药材的用量
    const uniqueHerbs = [];
    const herbMap = new Map();
    
    for (const herb of herbs) {
        if (herbMap.has(herb.name)) {
            const existingHerb = herbMap.get(herb.name);
            existingHerb.weight += herb.weight;
            if (herb.method && !existingHerb.method.includes(herb.method)) {
                existingHerb.method = existingHerb.method ? 
                    `${existingHerb.method}；${herb.method}` : herb.method;
            }
        } else {
            herbMap.set(herb.name, {...herb});
        }
    }
    
    herbMap.forEach(herb => {
        uniqueHerbs.push(herb);
    });
    
    return uniqueHerbs;
}
